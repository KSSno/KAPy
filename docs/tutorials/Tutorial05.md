# Tutorial 5 - Using a shapefile for area averaging

## Goal

To learn how a new shapefile is sourced and configured in KAPy.

## Point of departure

This tutorial follows on directly from the end of [Tutorial 1](Tutorial01.md).

## Instructions

1. In Tutorial 1, you performed a complete run of a KAPy pipeline, starting from a fresh installation.
That configuration defines a domain based on a cutout box (covering Ghana's boundaries) done on the original input climate data. The extent of this box is determined by the minimum and maximum latitude and longitude bounds of Ghana as specified in the `config.yaml` file - areal statistics are then generated by averaging over this domain. In a real setting, however, we are often interested in calculating statistics over polygons such as municipalities, regions, drainages or national boundaries, as defined in a `shapefile`. 

2. First, we need to create a folder where the shapefile is located/placed. A shapefile is not a single file but a collection of several files with different extensions, working together to represent spatial data. While in KAPy root folder, create the `shapefiles` folder into the `inputs` folder.

```
mkdir ./inputs/shapefiles/*
```

3. Obtain a relevant shapefile (e.g. of Ghana in this case). For this Ghana example, you can use the one [here](Tutorial05_files). Copy the files in this folder into the `inputs/shapefiles/` folder. Check the contents of the shapefile directory - you should now see files starting with `Ghana_regions.*`.

```
ls ./inputs/shapefiles/*
```

3. The shapefile is coupled into KAPy via arguments in the config file `./config/config.yaml`. Open this file in a text editor (e.g. `vi`). The path of the shapefile is specified under the `arealstats` category. The `shapefile` option gives the path to the shapefile (normally by pointing to the `*.shp` file. The `idColumn` option gives the name of the unique identifier of each polygon stored in the shapefile - you can find the name of this column by opening the shapefile in a GIS client or by using GeoPandas. You will end up with something like this:

```
# Configuration options------------------------------------
arealstats:
    useAreaWeighting: True
    shapefile: 'inputs/shapefiles/Ghana_regions.shp'
    idColumn: 'ADM1_PCODE'
```

5. So now we are ready to go. Firstly, let's see how snakemake responds to this new configuration. 

```
snakemake -n
```
KAPy will show that it needs to do a lot of things to effect these changes, but primarily in relation to recalculating the arealstatistics and the output plots. 

6. The revised DAG is also even more complicated as a result. Open the file `dag_tutorial05.png` and compare it to the previous DAGs.

```
snakemake --dag | dot -Tpng -Grankdir=LR > dag_tutorial04.png
```

7. Then, make it so!

```
snakemake --cores 1

```

9.  The averages over each area are stored in the `outputs/6.areal_statistics/ArealStatistics.csv` output file. Open this in a spreadsheet to see the results for each region in Ghana. You can also try plotting the results by combining them with the shapefile.

10. That concludes this tutorial. 
